<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>fais.al</title>

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <div class="wrapper">
        <header>
            <h1><a href="http://fais.al/">Faisal</a></h1>
            <p>not for public consumption</p>


            <p class="view"><a href="https://github.com/shaikhfaisal">View My GitHub Profile</a></p>

        </header>
    <section>
        <h3 id="jenkins-job-builder-templates-by-openstack">Jenkins Job Builder Templates by OpenStack</h3>

<p>Jenkins is a flexible and easy to use continous integration server. Coming from a Linux background, the GUI seems awkward and cumbersome to use. Enter Jenkins job templates. This is an excellent project by the people at OpenStack that allows you to define your jenkins jobs via yaml files. JJB then parses these yaml files and converts them into the XML format that Jenkins expects.</p>

<p>JJB solves a few problems that I have encounted when using Jenkins:</p>

<ol>
  <li>
    <p>Configuration drift - this is the familiar problem usually associated with hand-configured servers. Over time it becomes impossible to say with any degree of certainty exactly what is on a server if it is hand-configured. This is true of Jenkins as well for jobs that are setup using the GUI. The root cause is the high labour overhead of clicking through 50 configuration screens for 50 jobs.</p>
  </li>
  <li>
    <p>Changing a common step across 50 build jobs means that you will need to step through 50 web pages. Very demoralising and from a developers perspective a sin.</p>
  </li>
  <li>
    <p>Configuration done via the GUI screen cannot be versioned. Unless you start versioning the xml files that are generated by Jenkins. This gets ugly very fast and isnt a very elegant solution.</p>
  </li>
  <li>
    <p>Most importantly though - your Jenkins server becomes special i.e. indispensible. </p>
  </li>
</ol>

<h4 id="jobs">Jobs</h4>
<p>This is an example job template written using JJB.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">job-template</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;Run</span><span class="nv"> </span><span class="s">PHP</span><span class="nv"> </span><span class="s">unit</span><span class="nv"> </span><span class="s">tests&#39;</span>
    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
                  <span class="no">This job runs the php unit tests in this project.</span>
    <span class="l-Scalar-Plain">project-type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">freestyle</span>
    <span class="l-Scalar-Plain">logrotate</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">numToKeep</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">20</span>
    <span class="l-Scalar-Plain">scm</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">git</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="s">&#39;git@github.com:atom/atom.git&#39;</span>
          <span class="l-Scalar-Plain">branches</span><span class="p-Indicator">:</span>
            <span class="p-Indicator">-</span> <span class="s">&#39;origin/PreRelease&#39;</span>
          <span class="l-Scalar-Plain">credentials-id</span><span class="p-Indicator">:</span> <span class="s">&#39;some-uuid&#39;</span>
    <span class="l-Scalar-Plain">triggers</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pollscm</span><span class="p-Indicator">:</span> <span class="s">&quot;*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span>
    <span class="l-Scalar-Plain">builders</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="s">&quot;make</span><span class="nv"> </span><span class="s">test&quot;</span></code></pre></div>

<p>The job templates above is for the most part quite self-explanatory. It creates a job in Jenkins that polls a github repo every minute for changes and runs a set of commands when it finds that the repo has been updated. The credentials-id is the api key that needs to be provided to JJB so that it can talk to Jenkins via the REST api.</p>

<h4 id="job-templates">Job Templates</h4>
<p>The example above is overly simplified. The power of JJB comes when you parameterise these job templates like so:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">job-template</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;{job_name}_unittests&#39;</span>
    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
                  <span class="no">{job_description}</span>
    <span class="l-Scalar-Plain">project-type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">freestyle</span>
    <span class="l-Scalar-Plain">logrotate</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">numToKeep</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">20</span>
    <span class="l-Scalar-Plain">scm</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">git</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="s">&#39;{git_repo_url}&#39;</span>
          <span class="l-Scalar-Plain">branches</span><span class="p-Indicator">:</span>
            <span class="p-Indicator">-</span> <span class="s">&#39;{branch_to_monitor}&#39;</span>
          <span class="l-Scalar-Plain">credentials-id</span><span class="p-Indicator">:</span> <span class="s">&#39;{api_key}&#39;</span>
    <span class="l-Scalar-Plain">triggers</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pollscm</span><span class="p-Indicator">:</span> <span class="s">&quot;{polling_interval}&quot;</span>
    <span class="l-Scalar-Plain">builders</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="s">&quot;make</span><span class="nv"> </span><span class="s">test&quot;</span></code></pre></div>

<p>Now we have a job template that can be fed with values for the variables. This paves the way for re-using the job template. So how do we supply these job templates with variables. Enter projects.</p>

<h4 id="projects">Projects</h4>
<p>A project is again a yaml file that ties together job templates and variables.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">project</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;Demo</span><span class="nv"> </span><span class="s">jjb</span><span class="nv"> </span><span class="s">project&#39;</span>
    <span class="l-Scalar-Plain">api_key</span><span class="p-Indicator">:</span> <span class="s">&#39;bzzxx234-41asdf-4780-asdf9-f1poasdfsf&#39;</span>
    <span class="l-Scalar-Plain">branch_to_monitor</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="s">&#39;pre-master&#39;</span><span class="p-Indicator">:</span>
           <span class="l-Scalar-Plain">job_name</span><span class="p-Indicator">:</span> <span class="s">&#39;PRE-MASTER&#39;</span>
      <span class="p-Indicator">-</span> <span class="s">&#39;master&#39;</span><span class="p-Indicator">:</span>
           <span class="l-Scalar-Plain">display_branch_name</span><span class="p-Indicator">:</span> <span class="s">&#39;MASTER&#39;</span>
    <span class="l-Scalar-Plain">project_name</span><span class="p-Indicator">:</span> <span class="s">&#39;codename_alpha&#39;</span>
    <span class="l-Scalar-Plain">git_repo_url</span><span class="p-Indicator">:</span> <span class="s">&#39;git@example.com:company/project1.git&#39;</span>
    <span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="s">&#39;{job_name}_unittests&#39;</span>
      <span class="p-Indicator">-</span> <span class="s">&#39;{job_name}_styletests&#39;</span></code></pre></div>

<p>Everything in the projects.yml file apart from the jobs list is a series of variable definitions that get substituted into the job templates listed under the jobs list. </p>

<p>A powerful feature here is that you can define variables as lists. That causes JJB to create a job for every combination in the Cartesian product of the variables that are defined. In the projects.yml file above, it will cause the following jobs to be created:</p>

<p>PRE-MASTER_unittests: which will monitor the pre-master branch on the project1.git repo and run â€˜make testâ€™
PRE-MASTER_styletests: which will monitor the pre-master branch on the project1.git repo and run â€˜make styleâ€™
MASTER_styletests: which will monitor the master branch on the project1.git repo and run â€˜make styleâ€™
MASTER_styletests: which will monitor the master branch on the project1.git repo and run â€˜make styleâ€™</p>

<p>Thats four jobs in jenkins written across 2 concise yaml files! We can now store these yaml files in a git repository. That paves the way for semantic versioning and peer reviews. </p>

<p>If we need to change the specification of these jobs e.g. we want to change the polling interval we need only edit one config file and rebuild the job definitions.</p>


    </section>
        <footer>
            <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
        </footer>
    </div>

    <script src="/javascripts/scale.fix.js"></script>

</body>
</html>
